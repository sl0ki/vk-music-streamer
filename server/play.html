<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<script src="http://code.jquery.com/jquery-1.8.3.js" type="text/javascript"></script>
	<!-- <script src="http://127.0.0.1:8081/broadcasters.js" type="text/javascript"></script> -->
	<script src="http://92.63.109.20:8081/socket.io/socket.io.js" type="text/javascript"></script>	
	<!-- 
	<script src="main.js" type="text/javascript"></script>	
	<link rel="stylesheet" type="text/css" href="main.css"> -->
</head>
<body>
	<script>

		//* HTML5 PLayer Class

		html5Player = function() {
		 
		  var source = null;
		  var audio = document.createElement('audio');

		  this.getSource = function() {
		    return source;
		  }
		  this.load = function(src, position) {
		    source = src;
		    position = position || 0.0;
		    audio.setAttribute("src", src);
		    audio.addEventListener('loadedmetadata', function(){
		        audio.currentTime = position;
		        audio.removeEventListener('loadedmetadata');
		    });
		  };
		  this.play = function(src) {
		    audio.play();
		  };
		  
		  this.pause = function() {
		    if (source) {
		      audio.pause();
		    }
		  };
		  this.volume = function(percents) {
		    audio.volume = percents;
		  };
		  this.rewind = function(position) {
		  	/*audio.addEventListener('loadedmetadata', function(){
		        audio.currentTime = percents * audio.duration;
		        audio.removeEventListener('loadedmetadata');
		    });*/
			audio.currentTime = position;
		  };
		};

		//* Listener Class

		var Listener = function() {
		  var url = 'http://92.63.109.20:8081';
		  var socket;
		  var lEvents = [];

		  var closeSocket = function() {
		    if (socket) {
		      oldSocket = socket;
		      delete socket;
		      oldSocket.disconnect();
		    }    
		  };

		  this.stop = function() {
		    closeSocket();
		  } 

		  this.connect = function (bid) {
		    closeSocket();
		    var uid = Math.round(Math.random() * 1000000);
		    socket = io.connect(url, {'forceNew': true });

		    socket.on('connect', function () {
		      socket.emit('listen', {'uid': uid, 'bid': bid});
		      console.log('connect');	
		    });

		    socket.on("disconnect", function() {
		    	console.log('disconnect');	
		    });	

		    socket.on('start', function(data) {
		    	console.log('start');	
		    	//Vova
		    	if (lEvents['start']) 
		    		lEvents['start'](data);
		    })	    

		    socket.on('stop', function() {
		    	console.log('stop');	
		    	//Vova
		      if (lEvents['stop']) return lEvents['stop']();	
		    })	

		    socket.on('send', function (obj) {
		      if (lEvents[obj.name]) {
		        lEvents[obj.name](obj.data);
		      }
		    }); 
		  };

		  this.send = function (name, data) {
		    var obj = {
		      type: 'l',
		      name: name,      
		      data: data,
		    };
		    socket.emit('send', obj);
		  }

		  this.on = function (name, callback) {
		    lEvents[name] = callback;
		  }

		  var that = this;
		}

		/******************************************/

		var listener = new Listener();
		var Player = new html5Player();

		function Listen(uid) {

		  listener.connect(uid);

		  listener.on('start', function(data) {
		  	console.log(data);
	  		//var dtime = (Math.round((new Date().getTime() - data.currentTime) / 1000) + data.time) / data.duration;
	  		Player.load(data.source, data.time);//, dtime);
	  		//console.log(dtime)
	  		//Player.rewind(dtime);
	  		Player.play();
		  });  
		    
		  listener.on('change', function(src) {
		    Player.load(src);
		    Player.play();
		  });
		    
		  listener.on('play', function() {
		    Player.play();
		  });

		  listener.on('pause', function() {
		    Player.pause();
		  });

		  listener.on('rewind', function(pos) {
		    Player.rewind(pos);
		  });     

		  listener.on('disconnect', function(pos) {
		    Player.pause();
		  }); 		  
		}

		//* Init 
		broadcasters = ['32587609', '87274210', '26730845'];

        function play(uid) {
        	Listen(uid);
        }

		$(document).ready(function() {          
		    $.each(broadcasters, function(key, val) {
		        $('body').append('<div id="' + val + '" onclick="play(this.id)" class="bc-flat">' + val + '</div>');
		    });
		});
	</script>	
</body>
</html>